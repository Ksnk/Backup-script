<?xml version="1.0" encoding="UTF-8"?>
<!-- phing bild file -->
<project name="darts" default="build debug">
    <taskdef name="minify" classname="phing.tasks.ext.kpMinTask" />
    <taskdef name="preprocess" classname="phing.tasks.ext.preprocessor.preprocessTask" />

    <!-- Sets the DSTAMP, TSTAMP and TODAY properties -->
    <tstamp/>
    <property file="../env.prop" />

    <!-- настройка проекта на место -->
    <property name="sitedst" value="z:/home/localhost/www/rights"/>

    <!-- so let's go -->
    <target name="property">
        <echo file="svn.prop" append="false"><![CDATA[
version=RIGHTS - full power realisation, sergekoriakin@gmail.com, Ver : 0.1
license=License GNU/LGPL - Serge Koriakin - Jule 2010-2012
env_common=${common}
svn_revision=$WCREV$
svn_modified=$WCDATE$
svn_url=$WCURL$
lasttarget=${target}
]]>        </echo>
        <exec executable="SubWCRev" dir=".">
            <arg file="." />
            <arg file="svn.prop" />
            <arg file="svn.prop" />
            <arg value="-f" />
        </exec>
    </target>

    <target name="build.localhost" depends="property" description="build project">
        <property file="svn.prop" />
        <echo message="dst=${dst} target=${target}"/>
        <if>
            <equals arg1="${lasttarget}" arg2="${target}" />
        <then>
            <property name="force" value='${svn_modified}' />
        </then>
        <else>
            <property name="force" value='force' />
        </else>
        </if>
        <preprocess  config="config.xml" force='${force}'>
            <param name="dst" value="${dst}"/>
            <param name="target" value="${target}"/>
            <param file="svn.prop"/>
        </preprocess>
    </target>

    <target name="build release">
        <property name="dst" value="${sitedst}" />
        <property name="target" value="release" />
        <svncommit message="build ${target}" />
        <phingcall target="build.localhost"/>
        <phingcall target="minify-js"/>
        <phingcall target="minify-css"/>
    </target>

    <target name="build debug">
        <property name="dst" value="${sitedst}"/>
        <property name="target" value="debug" />
        <phingcall target="build.localhost"/>
    </target>

    <target name="minify-js">
        <minify suffix='.min' yuiPath="${YUicompressor}">
            <fileset dir="${dst}/js">
              <include name="site.js"/>
              <exclude name="*.min.js"/>
            </fileset>
        </minify>
    </target>

    <target name="minify-css">
        <minify suffix='.min' yuiPath="${YUicompressor}">
            <fileset dir="${dst}/css">
              <include name="*.css"/>
              <exclude name="*.min.css"/>
            </fileset>
        </minify>
    </target>

</project>